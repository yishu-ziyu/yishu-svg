<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YiShu SVG Â· æ™ºèƒ½æ•™å­¦åŠ¨ç”»ç”Ÿæˆå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        paper: '#fffdf5',
                        ink: '#2d2d2d',
                        brand: { DEFAULT: '#6366f1', 50: '#eef2ff', 100: '#e0e7ff', 600: '#4f46e5', 700: '#4338ca' }
                    }
                }
            }
        }
    </script>
    <style>
        .aegis-app {
            background-color: #fffdf5;
            font-family: system-ui, -apple-system, sans-serif;
        }

        .aegis-sketchy-border {
            border: 2px solid #2d2d2d;
            border-radius: 2px 255px 3px 25px / 255px 5px 225px 3px;
        }

        .aegis-btn-sketchy {
            border: 2px solid #2d2d2d;
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            box-shadow: 2px 3px 0px rgba(0, 0, 0, 0.8);
            transition: all 0.1s ease-in-out;
        }

        .aegis-btn-sketchy:hover {
            box-shadow: 1px 1px 0px rgba(0, 0, 0, 0.8);
            transform: translate(1px, 2px);
        }

        .aegis-btn-sketchy.active,
        .aegis-btn-sketchy:active {
            background-color: #4f46e5;
            color: white;
        }

        .aegis-btn-sketchy:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .aegis-card-sketchy {
            border: 2px solid #2d2d2d;
            border-radius: 5px;
            box-shadow: 4px 4px 0px rgba(0, 0, 0, 0.15);
            transition: all 0.2s;
            background: white;
        }

        .aegis-card-sketchy:hover {
            transform: rotate(-1deg) scale(1.02);
            box-shadow: 6px 6px 0px #4f46e5;
            z-index: 10;
        }

        .aegis-input-sketchy {
            border: 2px solid #cbd5e1;
            border-radius: 8px 2px 6px 3px;
            background-color: #fff;
        }

        .aegis-input-sketchy:focus {
            border-color: #4f46e5;
            outline: none;
            box-shadow: 2px 2px 0px #4f46e5;
        }

        .aegis-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .aegis-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 10px;
        }

        textarea {
            resize: none;
        }

        .svg-canvas {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 8px;
            overflow: hidden;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }
        .loading-pulse {
            animation: pulse 1.5s ease-in-out infinite;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-dot.connected { background: #22c55e; }
        .status-dot.error { background: #ef4444; }
        .status-dot.idle { background: #94a3b8; }
    </style>
</head>

<body class="bg-slate-100 min-h-screen">
    <div class="aegis-app w-full max-w-6xl mx-auto aegis-sketchy-border p-1 my-2 md:my-8 flex flex-col min-h-[700px] text-ink shadow-[5px_5px_0px_rgba(0,0,0,0.2)]">
        
        <!-- Header -->
        <div class="px-4 py-4 md:px-6 md:py-6 border-b-2 border-dashed border-slate-300 md:flex justify-between items-start bg-paper relative overflow-hidden">
            <div class="relative z-10">
                <div class="flex items-center gap-3 mb-2">
                    <span class="text-xs font-black bg-brand-600 text-white px-2 py-0.5 transform -rotate-2">AI POWERED</span>
                    <h2 class="text-2xl md:text-3xl font-black text-ink">YiShu SVG åŠ¨ç”»ç”Ÿæˆå™¨</h2>
                </div>
                <div class="text-slate-600 text-sm md:text-base space-y-1 font-medium leading-relaxed">
                    <p>ç”¨ <strong class="text-brand-600 bg-brand-50 px-1">è‡ªç„¶è¯­è¨€</strong> ç”ŸæˆåŠ¨æ€ SVG æ•™å­¦åŠ¨ç”»ã€‚</p>
                    <p>æ•°å­¦å…¬å¼ã€ç‰©ç†å®šå¾‹ã€ç¥ç»ç½‘ç»œã€æ—¶é—´è½´ â€”â€” ä¸€åˆ‡çš†å¯åŠ¨ç”»åŒ–ã€‚</p>
                </div>
            </div>
            <div class="mt-4 md:mt-0 flex items-center gap-2">
                <span class="status-dot idle" id="status-dot"></span>
                <span class="text-xs text-slate-500" id="status-text">æœªè¿æ¥</span>
                <button id="settings-btn" class="aegis-btn-sketchy bg-white px-3 py-1 text-xs font-bold">âš™ï¸ API è®¾ç½®</button>
            </div>
        </div>

        <!-- Style Selector -->
        <div class="px-6 py-4 border-b-2 border-dashed border-slate-300 flex flex-wrap justify-between items-center bg-slate-50 gap-4">
            <div>
                <h3 class="text-lg font-black text-ink flex items-center gap-2">
                    é€‰æ‹©åŠ¨ç”»é£æ ¼
                    <span class="text-sm bg-brand-600 text-white px-2 py-0.5 rounded-full border-2 border-black rotate-2 shadow-[1px_1px_0px_black] text-xs">Pro</span>
                </h3>
            </div>
            <div class="flex flex-wrap gap-2" id="style-buttons">
                <button class="aegis-btn-sketchy bg-white px-4 py-2 text-sm font-bold active" data-style="manim">ğŸ“ Manim é£æ ¼</button>
                <button class="aegis-btn-sketchy bg-white px-4 py-2 text-sm font-bold" data-style="timeline">ğŸ“… æ—¶é—´è½´</button>
                <button class="aegis-btn-sketchy bg-white px-4 py-2 text-sm font-bold" data-style="minimal">âœ¨ æç®€é£æ ¼</button>
                <button class="aegis-btn-sketchy bg-white px-4 py-2 text-sm font-bold" data-style="artistic">ğŸ¨ è‰ºæœ¯é£æ ¼</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex flex-col lg:flex-row flex-1 overflow-hidden bg-white/50">
            
            <!-- Input Panel -->
            <div class="w-full lg:w-96 border-b-2 lg:border-b-0 lg:border-r-2 border-slate-200 border-dashed flex-shrink-0 p-4 md:p-6 overflow-y-auto aegis-scrollbar">
                <h4 class="text-sm font-black text-slate-500 uppercase mb-4">âœï¸ åŠ¨ç”»æè¿°</h4>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">æ•™å­¦ä¸»é¢˜</label>
                        <input type="text" id="topic-input" 
                               class="w-full aegis-input-sketchy p-3 text-sm" 
                               placeholder="ä¾‹å¦‚ï¼šäºŒæ¬¡å‡½æ•°ã€ç¥ç»ç½‘ç»œã€åŠ¨é‡å®ˆæ’...">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">è¯¦ç»†è¦æ±‚ <span class="text-slate-400 font-normal">(å¯é€‰)</span></label>
                        <textarea id="desc-input" 
                                  class="w-full aegis-input-sketchy p-3 text-sm h-32" 
                                  placeholder="æè¿°ä½ æƒ³è¦çš„åŠ¨ç”»æ•ˆæœ...&#10;&#10;ä¾‹å¦‚ï¼š&#10;- å±•ç¤º y = xÂ² çš„å›¾åƒ&#10;- åŠ¨æ€æ ‡æ³¨é¡¶ç‚¹ä½ç½®&#10;- ä½¿ç”¨æ·±è‰²èƒŒæ™¯"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">ğŸ“š å¿«æ·æ¨¡æ¿</label>
                        
                        <!-- é€šç”¨æ¨¡æ¿ -->
                        <div class="grid grid-cols-2 gap-2 mb-3">
                            <button class="template-btn aegis-card-sketchy p-3 text-left" data-template="math">
                                <span class="text-lg">ğŸ“Š</span>
                                <span class="text-xs font-bold block mt-1">æ•°å­¦å‡½æ•°</span>
                            </button>
                            <button class="template-btn aegis-card-sketchy p-3 text-left" data-template="neural">
                                <span class="text-lg">ğŸ§ </span>
                                <span class="text-xs font-bold block mt-1">ç¥ç»ç½‘ç»œ</span>
                            </button>
                            <button class="template-btn aegis-card-sketchy p-3 text-left" data-template="physics">
                                <span class="text-lg">âš›ï¸</span>
                                <span class="text-xs font-bold block mt-1">ç‰©ç†è¿‡ç¨‹</span>
                            </button>
                            <button class="template-btn aegis-card-sketchy p-3 text-left" data-template="timeline">
                                <span class="text-lg">ğŸ“…</span>
                                <span class="text-xs font-bold block mt-1">å†å²æ—¶é—´è½´</span>
                            </button>
                        </div>
                        
                        <!-- ç»æµå­¦æ¨¡æ¿ -->
                        <label class="block text-xs font-bold text-brand-600 mb-2">ğŸ’° ç»æµå­¦ä¸“åŒº</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button class="template-btn aegis-card-sketchy p-3 text-left border-brand-200" data-template="supply-demand">
                                <span class="text-lg">ğŸ“ˆ</span>
                                <span class="text-xs font-bold block mt-1">ä¾›éœ€æ›²çº¿</span>
                            </button>
                            <button class="template-btn aegis-card-sketchy p-3 text-left border-brand-200" data-template="cost-curves">
                                <span class="text-lg">ğŸ“‰</span>
                                <span class="text-xs font-bold block mt-1">æˆæœ¬æ›²çº¿</span>
                            </button>
                            <button class="template-btn aegis-card-sketchy p-3 text-left border-brand-200" data-template="is-lm">
                                <span class="text-lg">ğŸ¦</span>
                                <span class="text-xs font-bold block mt-1">IS-LM æ¨¡å‹</span>
                            </button>
                            <button class="template-btn aegis-card-sketchy p-3 text-left border-brand-200" data-template="ad-as">
                                <span class="text-lg">ğŸ“Š</span>
                                <span class="text-xs font-bold block mt-1">AD-AS æ¨¡å‹</span>
                            </button>
                        </div>
                    </div>
                    
                    <button id="generate-btn" class="w-full aegis-btn-sketchy bg-brand-600 text-white font-bold py-4 px-6 text-lg mt-4">
                        ğŸš€ ç”Ÿæˆ SVG åŠ¨ç”»
                    </button>
                    
                    <div id="error-msg" class="hidden text-red-600 text-sm bg-red-50 p-3 rounded border border-red-200"></div>
                </div>
            </div>
            
            <!-- Preview Panel -->
            <div class="flex-1 p-4 md:p-6 flex flex-col overflow-hidden">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-sm font-black text-slate-500 uppercase">ğŸ¬ åŠ¨ç”»é¢„è§ˆ</h4>
                    <div class="flex gap-2">
                        <button id="view-code-btn" class="aegis-btn-sketchy bg-white px-3 py-1 text-xs font-bold">{ } æŸ¥çœ‹ä»£ç </button>
                        <button id="download-btn" class="aegis-btn-sketchy bg-white px-3 py-1 text-xs font-bold">ğŸ’¾ ä¸‹è½½ SVG</button>
                        <button id="fullscreen-btn" class="aegis-btn-sketchy bg-white px-3 py-1 text-xs font-bold">â›¶ å…¨å±</button>
                    </div>
                </div>
                
                <div id="svg-canvas" class="svg-canvas flex-1 flex items-center justify-center min-h-[400px] relative">
                    <div id="svg-placeholder" class="text-center text-slate-400">
                        <span class="text-6xl block mb-4 opacity-30">ğŸ¨</span>
                        <p class="text-sm">è¾“å…¥æ•™å­¦ä¸»é¢˜ï¼Œç‚¹å‡»ç”ŸæˆæŒ‰é’®</p>
                        <p class="text-xs mt-2 opacity-60">AI å°†ä¸ºä½ åˆ›å»ºåŠ¨æ€ SVG åŠ¨ç”»</p>
                    </div>
                    <div id="svg-loading" class="hidden absolute inset-0 flex items-center justify-center bg-black/50">
                        <div class="text-center text-white">
                            <span class="text-4xl block mb-4 loading-pulse">âš¡</span>
                            <p class="text-sm font-bold" id="loading-text">æ­£åœ¨ç”ŸæˆåŠ¨ç”»...</p>
                        </div>
                    </div>
                    <div id="svg-render" class="w-full h-full"></div>
                </div>
            </div>
        </div>
        
        <div class="px-6 py-3 border-t-2 border-dashed border-slate-300 text-center text-xs text-slate-400 bg-paper">
            <p>YiShu SVG Â· Powered by GLM-4.7-Flash</p>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-[9999] hidden bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-paper rounded-lg border-4 border-ink shadow-[8px_8px_0px_black] w-full max-w-lg flex flex-col overflow-hidden">
            <div class="px-6 py-4 border-b-2 border-ink border-dashed flex justify-between items-center bg-brand-50">
                <h3 class="font-bold text-xl text-ink">âš™ï¸ API è®¾ç½®</h3>
                <button id="close-settings-btn" class="text-ink hover:text-brand-600 border-2 border-ink rounded-full w-8 h-8 flex items-center justify-center hover:bg-white shadow-[2px_2px_0px_black]">âœ•</button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">API æä¾›å•†</label>
                    <select id="api-provider" class="w-full aegis-input-sketchy p-3 text-sm">
                        <option value="zhipu">æ™ºè°± AI (GLM-4.7-Flash)</option>
                        <option value="nvidia">NVIDIA NIM (GLM-4.7 / MiniMax)</option>
                    </select>
                </div>
                <div id="zhipu-config">
                    <label class="block text-sm font-bold text-slate-700 mb-2">æ™ºè°± API Key</label>
                    <input type="password" id="zhipu-key" class="w-full aegis-input-sketchy p-3 text-sm" placeholder="è¾“å…¥ä½ çš„æ™ºè°± API Key">
                    <p class="text-xs text-slate-500 mt-1">è·å–: <a href="https://open.bigmodel.cn" target="_blank" class="text-brand-600 underline">open.bigmodel.cn</a></p>
                </div>
                <div id="nvidia-config" class="hidden">
                    <label class="block text-sm font-bold text-slate-700 mb-2">NVIDIA API Key</label>
                    <input type="password" id="nvidia-key" class="w-full aegis-input-sketchy p-3 text-sm" placeholder="nvapi-xxx">
                    <label class="block text-sm font-bold text-slate-700 mb-2 mt-4">æ¨¡å‹é€‰æ‹©</label>
                    <select id="nvidia-model" class="w-full aegis-input-sketchy p-3 text-sm">
                        <option value="z-ai/glm4.7">GLM-4.7</option>
                        <option value="minimaxai/minimax-m2.1">MiniMax M2.1</option>
                    </select>
                </div>
                <button id="save-settings-btn" class="w-full aegis-btn-sketchy bg-brand-600 text-white font-bold py-3 px-6">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
            </div>
        </div>
    </div>

    <!-- Code Modal -->
    <div id="code-modal" class="fixed inset-0 z-[9999] hidden bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-paper rounded-lg border-4 border-ink shadow-[8px_8px_0px_black] w-full max-w-4xl max-h-[80vh] flex flex-col overflow-hidden">
            <div class="px-6 py-4 border-b-2 border-ink border-dashed flex justify-between items-center bg-brand-50">
                <h3 class="font-bold text-xl text-ink">ğŸ“ SVG æºä»£ç </h3>
                <button id="close-modal-btn" class="text-ink hover:text-brand-600 border-2 border-ink rounded-full w-8 h-8 flex items-center justify-center hover:bg-white shadow-[2px_2px_0px_black]">âœ•</button>
            </div>
            <div class="flex-1 overflow-auto p-4">
                <textarea id="code-editor" class="w-full h-full min-h-[400px] aegis-input-sketchy p-4 font-mono text-sm" spellcheck="false"></textarea>
            </div>
            <div class="px-6 py-4 border-t-2 border-ink border-dashed flex justify-end gap-2 bg-slate-50">
                <button id="copy-code-btn" class="aegis-btn-sketchy bg-brand-600 text-white font-bold py-2 px-6">ğŸ“‹ å¤åˆ¶ä»£ç </button>
                <button id="apply-code-btn" class="aegis-btn-sketchy bg-white font-bold py-2 px-6">âœ… åº”ç”¨ä¿®æ”¹</button>
            </div>
        </div>
    </div>

    <script>
        // ========== System Prompt ==========
        const SYSTEM_PROMPT = `You are an expert SVG animator and educational content creator. Generate animated SVG code for educational concepts.

## Requirements
- Output ONLY valid SVG code (no markdown, no explanation)
- Use viewBox="0 0 800 600" for responsive sizing
- Include xmlns="http://www.w3.org/2000/svg"

## Animation Techniques (MUST use at least one)
1. SVG SMIL: <animate>, <animateTransform>
2. CSS @keyframes in <style> tags
3. stroke-dasharray/stroke-dashoffset for drawing effects

## Style
- Background: #1a1a2e (dark)
- Primary: #4f46e5 (indigo)
- Accent: #22d3ee (cyan)
- Text: #e2e8f0
- Font: 'Inter', system-ui, sans-serif

## Animation Principles
- Duration: 2-4 seconds
- Use ease-in-out timing
- repeatCount="indefinite" for loops
- Stagger animations by 0.2-0.5s

Output ONLY the <svg>...</svg> code, nothing else.`;

        // ========== DOM Elements ==========
        const topicInput = document.getElementById('topic-input');
        const descInput = document.getElementById('desc-input');
        const generateBtn = document.getElementById('generate-btn');
        const svgCanvas = document.getElementById('svg-canvas');
        const svgRender = document.getElementById('svg-render');
        const svgPlaceholder = document.getElementById('svg-placeholder');
        const svgLoading = document.getElementById('svg-loading');
        const loadingText = document.getElementById('loading-text');
        const errorMsg = document.getElementById('error-msg');
        const styleButtons = document.querySelectorAll('[data-style]');
        const templateBtns = document.querySelectorAll('.template-btn');
        const viewCodeBtn = document.getElementById('view-code-btn');
        const downloadBtn = document.getElementById('download-btn');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const codeModal = document.getElementById('code-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const codeEditor = document.getElementById('code-editor');
        const copyCodeBtn = document.getElementById('copy-code-btn');
        const applyCodeBtn = document.getElementById('apply-code-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsBtn = document.getElementById('close-settings-btn');
        const apiProvider = document.getElementById('api-provider');
        const zhipuConfig = document.getElementById('zhipu-config');
        const nvidiaConfig = document.getElementById('nvidia-config');
        const zhipuKey = document.getElementById('zhipu-key');
        const nvidiaKey = document.getElementById('nvidia-key');
        const nvidiaModel = document.getElementById('nvidia-model');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');

        let currentStyle = 'manim';
        let currentSvgCode = '';

        // ========== Default API Keys ==========
        const DEFAULT_KEYS = {
            zhipu: '6de87e37dede4d7a8ca71d7f522292cd.gMYe3xp0DabVCuG1',
            nvidia: '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'
        };

        // ========== Load Settings ==========
        function loadSettings() {
            let settings = JSON.parse(localStorage.getItem('aegis_settings') || '{}');
            
            // é¦–æ¬¡åŠ è½½æ—¶è®¾ç½®é»˜è®¤å€¼
            if (!settings.zhipuKey && !settings.nvidiaKey) {
                settings = {
                    provider: 'zhipu',  // é»˜è®¤ä½¿ç”¨æ™ºè°±
                    zhipuKey: DEFAULT_KEYS.zhipu,
                    nvidiaKey: DEFAULT_KEYS.nvidia,
                    nvidiaModel: 'z-ai/glm4.7'
                };
                localStorage.setItem('aegis_settings', JSON.stringify(settings));
            }
            
            if (settings.provider) apiProvider.value = settings.provider;
            if (settings.zhipuKey) zhipuKey.value = settings.zhipuKey;
            if (settings.nvidiaKey) nvidiaKey.value = settings.nvidiaKey;
            if (settings.nvidiaModel) nvidiaModel.value = settings.nvidiaModel;
            toggleProviderConfig();
            updateStatus();
        }

        function saveSettings() {
            const settings = {
                provider: apiProvider.value,
                zhipuKey: zhipuKey.value,
                nvidiaKey: nvidiaKey.value,
                nvidiaModel: nvidiaModel.value
            };
            localStorage.setItem('aegis_settings', JSON.stringify(settings));
            updateStatus();
            settingsModal.classList.add('hidden');
        }

        function toggleProviderConfig() {
            zhipuConfig.classList.toggle('hidden', apiProvider.value !== 'zhipu');
            nvidiaConfig.classList.toggle('hidden', apiProvider.value !== 'nvidia');
        }

        function updateStatus() {
            const settings = JSON.parse(localStorage.getItem('aegis_settings') || '{}');
            const hasKey = (settings.provider === 'zhipu' && settings.zhipuKey) || 
                          (settings.provider === 'nvidia' && settings.nvidiaKey);
            statusDot.className = hasKey ? 'status-dot connected' : 'status-dot idle';
            statusText.textContent = hasKey ? (settings.provider === 'zhipu' ? 'GLM-4.7' : 'NVIDIA') : 'æœªé…ç½®';
        }

        // ========== Templates ==========
        const TEMPLATES = {
            // é€šç”¨æ¨¡æ¿
            math: { topic: 'äºŒæ¬¡å‡½æ•° y = xÂ²', desc: 'å±•ç¤ºæŠ›ç‰©çº¿å›¾åƒï¼ŒåŠ¨æ€æ ‡æ³¨é¡¶ç‚¹ (0,0)ï¼Œä½¿ç”¨æ·±è‰²èƒŒæ™¯å’Œç´«è‰²æ›²çº¿ï¼Œæ›²çº¿è¦æœ‰ç»˜åˆ¶åŠ¨ç”»' },
            neural: { topic: 'äººå·¥ç¥ç»ç½‘ç»œç»“æ„', desc: 'å±•ç¤º3å±‚ç¥ç»ç½‘ç»œï¼šè¾“å…¥å±‚3ä¸ªèŠ‚ç‚¹ï¼Œéšè—å±‚4ä¸ªèŠ‚ç‚¹ï¼Œè¾“å‡ºå±‚1ä¸ªèŠ‚ç‚¹ï¼Œç”¨è¿çº¿è¡¨ç¤ºæƒé‡ï¼Œæœ‰æ•°æ®æµåŠ¨åŠ¨ç”»' },
            physics: { topic: 'åŠ¨é‡å®ˆæ’å®šå¾‹', desc: 'ä¸¤ä¸ªå°çƒç¢°æ’ï¼šå·¦è¾¹çº¢çƒå‘å³ç§»åŠ¨æ’å‡»é™æ­¢çš„è“çƒï¼Œç¢°æ’åè“çƒå‘å³ç§»åŠ¨ï¼Œçº¢çƒåœæ­¢ï¼Œå±•ç¤ºåŠ¨é‡ä¼ é€’' },
            timeline: { topic: 'äººå·¥æ™ºèƒ½å‘å±•å²', desc: 'æ°´å¹³æ—¶é—´è½´ä»1956åˆ°2024ï¼Œæ ‡æ³¨ï¼š1956è¾¾ç‰¹èŒ…æ–¯ã€1997æ·±è“ã€2016AlphaGoã€2022ChatGPTï¼ŒèŠ‚ç‚¹ä¾æ¬¡ç‚¹äº®' },
            
            // ç»æµå­¦æ¨¡æ¿
            'supply-demand': { 
                topic: 'å¾®è§‚ç»æµå­¦ï¼šä¾›éœ€æ›²çº¿', 
                desc: 'å±•ç¤ºå¸‚åœºå‡è¡¡ï¼šå‘å³ä¸‹å€¾æ–œçš„çº¢è‰²éœ€æ±‚æ›²çº¿(D)ï¼Œå‘å³ä¸Šå€¾æ–œçš„ç»¿è‰²ä¾›ç»™æ›²çº¿(S)ï¼Œä¸¤æ›²çº¿äº¤äºå‡è¡¡ç‚¹Eã€‚ç”¨è™šçº¿æ ‡æ³¨å‡è¡¡ä»·æ ¼P*å’Œå‡è¡¡æ•°é‡Q*ï¼Œæ›²çº¿è¦æœ‰ç»˜åˆ¶åŠ¨ç”»ï¼Œå‡è¡¡ç‚¹è¦æœ‰è„‰åŠ¨æ•ˆæœ' 
            },
            'cost-curves': { 
                topic: 'å¾®è§‚ç»æµå­¦ï¼šæˆæœ¬æ›²çº¿', 
                desc: 'å±•ç¤ºå‚å•†æˆæœ¬æ›²çº¿ï¼šUå‹çš„çº¢è‰²è¾¹é™…æˆæœ¬æ›²çº¿(MC)ã€Uå‹çš„ç»¿è‰²å¹³å‡æ€»æˆæœ¬æ›²çº¿(ATC)ã€Uå‹çš„è“è‰²å¹³å‡å¯å˜æˆæœ¬æ›²çº¿(AVC)ã€é€’å‡çš„ç´«è‰²å¹³å‡å›ºå®šæˆæœ¬æ›²çº¿(AFC)ã€‚MCç©¿è¿‡ATCå’ŒAVCçš„æœ€ä½ç‚¹ï¼Œæ ‡æ³¨äº¤ç‚¹' 
            },
            'is-lm': { 
                topic: 'å®è§‚ç»æµå­¦ï¼šIS-LM æ¨¡å‹', 
                desc: 'å±•ç¤ºäº§å“å¸‚åœºå’Œè´§å¸å¸‚åœºå‡è¡¡ï¼šå‘å³ä¸‹å€¾æ–œçš„çº¢è‰²ISæ›²çº¿(äº§å“å¸‚åœº)ï¼Œå‘å³ä¸Šå€¾æ–œçš„ç»¿è‰²LMæ›²çº¿(è´§å¸å¸‚åœº)ï¼Œäº¤äºå‡è¡¡ç‚¹Eã€‚æ¨ªè½´ä¸ºå›½æ°‘æ”¶å…¥Yï¼Œçºµè½´ä¸ºåˆ©ç‡rï¼Œæ ‡æ³¨å‡è¡¡åˆ©ç‡r*å’Œå‡è¡¡æ”¶å…¥Y*' 
            },
            'ad-as': { 
                topic: 'å®è§‚ç»æµå­¦ï¼šAD-AS æ¨¡å‹', 
                desc: 'å±•ç¤ºæ€»éœ€æ±‚æ€»ä¾›ç»™æ¨¡å‹ï¼šå‘å³ä¸‹å€¾æ–œçš„è“è‰²æ€»éœ€æ±‚æ›²çº¿(AD)ï¼Œå‚ç›´çš„çº¢è‰²é•¿æœŸæ€»ä¾›ç»™æ›²çº¿(LRAS)ï¼Œå‘å³ä¸Šå€¾æ–œçš„æ©™è‰²çŸ­æœŸæ€»ä¾›ç»™æ›²çº¿(SRAS)ã€‚æ¨ªè½´ä¸ºå®é™…GDP(Y)ï¼Œçºµè½´ä¸ºä»·æ ¼æ°´å¹³(P)ï¼Œæ ‡æ³¨é•¿æœŸå‡è¡¡ç‚¹' 
            }
        };

        const STYLE_HINTS = {
            manim: 'ä½¿ç”¨ Manim åŠ¨ç”»é£æ ¼ï¼šç§‘å­¦å¯è§†åŒ–ï¼Œç²¾ç¡®çš„åæ ‡ç³»ï¼Œä¼˜é›…çš„æ›²çº¿åŠ¨ç”»',
            timeline: 'ä½¿ç”¨æ—¶é—´è½´é£æ ¼ï¼šæ°´å¹³æˆ–å‚ç›´è½´ï¼ŒèŠ‚ç‚¹ä¾æ¬¡ç‚¹äº®ï¼Œæ¸…æ™°çš„æ—¥æœŸæ ‡æ³¨',
            minimal: 'ä½¿ç”¨æç®€é£æ ¼ï¼šç®€æ´çº¿æ¡ï¼Œå•è‰²è°ƒï¼Œå°‘é‡åŠ¨ç”»',
            artistic: 'ä½¿ç”¨è‰ºæœ¯é£æ ¼ï¼šæ¸å˜è‰²å½©ï¼Œæµç•…æ›²çº¿ï¼Œå¯Œæœ‰ç¾æ„Ÿ'
        };

        // ========== API Call ==========
        async function callAPI(prompt) {
            const settings = JSON.parse(localStorage.getItem('aegis_settings') || '{}');
            
            if (settings.provider === 'nvidia' && settings.nvidiaKey) {
                return await callNvidiaAPI(prompt, settings);
            } else if (settings.zhipuKey) {
                return await callZhipuAPI(prompt, settings);
            } else {
                throw new Error('è¯·å…ˆé…ç½® API Keyï¼ˆç‚¹å‡»å³ä¸Šè§’è®¾ç½®æŒ‰é’®ï¼‰');
            }
        }

        async function callZhipuAPI(prompt, settings) {
            const response = await fetch('https://open.bigmodel.cn/api/paas/v4/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${settings.zhipuKey}`
                },
                body: JSON.stringify({
                    model: 'glm-4.7-flash',
                    messages: [
                        { role: 'system', content: SYSTEM_PROMPT },
                        { role: 'user', content: prompt }
                    ],
                    max_tokens: 8192,
                    temperature: 0.7
                })
            });

            if (!response.ok) {
                const err = await response.json().catch(() => ({}));
                throw new Error(err.error?.message || `API é”™è¯¯: ${response.status}`);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        async function callNvidiaAPI(prompt, settings) {
            const response = await fetch('https://integrate.api.nvidia.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${settings.nvidiaKey}`
                },
                body: JSON.stringify({
                    model: settings.nvidiaModel || 'z-ai/glm4.7',
                    messages: [
                        { role: 'system', content: SYSTEM_PROMPT },
                        { role: 'user', content: prompt }
                    ],
                    max_tokens: 8192,
                    temperature: 0.7
                })
            });

            if (!response.ok) {
                const err = await response.json().catch(() => ({}));
                throw new Error(err.error?.message || `API é”™è¯¯: ${response.status}`);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        function extractSVG(text) {
            // æå– SVG ä»£ç 
            const svgMatch = text.match(/<svg[\s\S]*?<\/svg>/i);
            if (svgMatch) return svgMatch[0];
            
            // å¦‚æœåœ¨ä»£ç å—ä¸­
            const codeBlockMatch = text.match(/```(?:svg|xml)?\s*([\s\S]*?)```/);
            if (codeBlockMatch) {
                const inner = codeBlockMatch[1];
                const innerSvg = inner.match(/<svg[\s\S]*?<\/svg>/i);
                if (innerSvg) return innerSvg[0];
            }
            
            return null;
        }

        // ========== Event Handlers ==========
        styleButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                styleButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentStyle = btn.dataset.style;
            });
        });

        templateBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const template = TEMPLATES[btn.dataset.template];
                if (template) {
                    topicInput.value = template.topic;
                    descInput.value = template.desc;
                }
            });
        });

        generateBtn.addEventListener('click', async () => {
            const topic = topicInput.value.trim();
            if (!topic) {
                alert('è¯·è¾“å…¥æ•™å­¦ä¸»é¢˜');
                return;
            }

            svgPlaceholder.classList.add('hidden');
            svgLoading.classList.remove('hidden');
            svgRender.innerHTML = '';
            errorMsg.classList.add('hidden');
            generateBtn.disabled = true;
            loadingText.textContent = 'æ­£åœ¨ç”ŸæˆåŠ¨ç”»...';

            const prompt = `ç”Ÿæˆä¸€ä¸ªå…³äº"${topic}"çš„æ•™å­¦åŠ¨ç”» SVGã€‚
${descInput.value ? `è¯¦ç»†è¦æ±‚ï¼š${descInput.value}` : ''}
é£æ ¼è¦æ±‚ï¼š${STYLE_HINTS[currentStyle] || ''}

è¯·ç›´æ¥è¾“å‡º SVG ä»£ç ï¼Œä¸è¦ä»»ä½•è§£é‡Šã€‚`;

            try {
                const result = await callAPI(prompt);
                const svgCode = extractSVG(result);
                
                if (svgCode) {
                    currentSvgCode = svgCode;
                    svgRender.innerHTML = svgCode;
                    svgLoading.classList.add('hidden');
                } else {
                    throw new Error('æœªèƒ½ä»å“åº”ä¸­æå–æœ‰æ•ˆçš„ SVG ä»£ç ');
                }
            } catch (err) {
                svgLoading.classList.add('hidden');
                svgPlaceholder.classList.remove('hidden');
                errorMsg.textContent = `âŒ ${err.message}`;
                errorMsg.classList.remove('hidden');
                console.error(err);
            } finally {
                generateBtn.disabled = false;
            }
        });

        settingsBtn.addEventListener('click', () => settingsModal.classList.remove('hidden'));
        closeSettingsBtn.addEventListener('click', () => settingsModal.classList.add('hidden'));
        settingsModal.addEventListener('click', e => { if (e.target === settingsModal) settingsModal.classList.add('hidden'); });
        apiProvider.addEventListener('change', toggleProviderConfig);
        saveSettingsBtn.addEventListener('click', saveSettings);

        viewCodeBtn.addEventListener('click', () => {
            if (!currentSvgCode) { alert('è¯·å…ˆç”Ÿæˆ SVG'); return; }
            codeEditor.value = currentSvgCode;
            codeModal.classList.remove('hidden');
        });

        closeModalBtn.addEventListener('click', () => codeModal.classList.add('hidden'));
        codeModal.addEventListener('click', e => { if (e.target === codeModal) codeModal.classList.add('hidden'); });

        copyCodeBtn.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(codeEditor.value);
                copyCodeBtn.textContent = 'âœ… å·²å¤åˆ¶!';
                setTimeout(() => copyCodeBtn.textContent = 'ğŸ“‹ å¤åˆ¶ä»£ç ', 2000);
            } catch (e) {
                codeEditor.select();
                document.execCommand('copy');
            }
        });

        applyCodeBtn.addEventListener('click', () => {
            currentSvgCode = codeEditor.value;
            svgRender.innerHTML = currentSvgCode;
            codeModal.classList.add('hidden');
        });

        downloadBtn.addEventListener('click', () => {
            if (!currentSvgCode) { alert('è¯·å…ˆç”Ÿæˆ SVG'); return; }
            const blob = new Blob([currentSvgCode], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'aegis-animation.svg';
            a.click();
            URL.revokeObjectURL(url);
        });

        fullscreenBtn.addEventListener('click', () => {
            if (svgCanvas.requestFullscreen) svgCanvas.requestFullscreen();
        });

        // Init
        loadSettings();
    </script>
</body>

</html>
